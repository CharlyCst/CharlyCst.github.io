<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="I just learned about dlopen a few days ago while scrolling on Twitter, it&amp;rsquo;s a function for programmatically loading dynamic libraries and then calling into them or using exported symbols. I already knew it was possible before, but until then I didn&amp;rsquo;t know how exactly, but now that all this power is at my fingertips I started to think about all kind of crazy things I could do with that." />
<meta name="keywords" content="Charly Castes, CharlyCst, compilers, systems, operating systems" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://charlycst.github.io/posts/jit-ing-rust/" />


    <title>
        
            CharlyCst 
        
    </title>







<link rel="stylesheet" href="/main.min.3f97b3b5428c94755991f5459aa7ab633505d96b6f9dafd68dbb4b6bc111a56a.css">




<meta itemprop="name" content="Compiling Rust Just-In-Time, the easy way">
<meta itemprop="description" content="I just learned about dlopen a few days ago while scrolling on Twitter, it&rsquo;s a function for programmatically loading dynamic libraries and then calling into them or using exported symbols. I already knew it was possible before, but until then I didn&rsquo;t know how exactly, but now that all this power is at my fingertips I started to think about all kind of crazy things I could do with that."><meta itemprop="datePublished" content="2021-03-27T10:52:44+01:00" />
<meta itemprop="dateModified" content="2021-03-27T10:52:44+01:00" />
<meta itemprop="wordCount" content="1708"><meta itemprop="image" content="https://charlycst.github.io"/>
<meta itemprop="keywords" content="rust," /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://charlycst.github.io"/>

<meta name="twitter:title" content="Compiling Rust Just-In-Time, the easy way"/>
<meta name="twitter:description" content="I just learned about dlopen a few days ago while scrolling on Twitter, it&rsquo;s a function for programmatically loading dynamic libraries and then calling into them or using exported symbols. I already knew it was possible before, but until then I didn&rsquo;t know how exactly, but now that all this power is at my fingertips I started to think about all kind of crazy things I could do with that."/>





    <meta property="article:published_time" content="2021-03-27 10:52:44 &#43;0100 CET" />








    </head>

    <body class="">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">cd ~</span>
            
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://charlycst.github.io/posts">/posts</a></li><li><a href="https://charlycst.github.io/research">/research</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>9 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://charlycst.github.io/posts/jit-ing-rust/">Compiling Rust Just-In-Time, the easy way</a>
            </h1>

            

            <div class="post-content">
                <p>I just learned about <a href="https://linux.die.net/man/3/dlopen"><code>dlopen</code></a> a few days ago while scrolling on Twitter, it&rsquo;s a function for programmatically loading dynamic libraries and then calling into them or using exported symbols.
I already knew it was possible before, but until then I didn&rsquo;t know <em>how</em> exactly, but now that all this power is at my fingertips I started to think about all kind of crazy things I could do with that.</p>
<p>For instance, I can load libraries at runtime, but nothing prevent me from also building them at runtime with my compiler right? So what happens if I dynamically generate code, compile it, link it to my program and call into it? According to Wikipedia that&rsquo;s exactly what Just-In-Time (JIT) compilation is:</p>
<blockquote>
<p>In computing, just-in-time (JIT) compilation (also dynamic translation or run-time compilations) is a way of executing computer code that involves compilation during execution of a program – at run time – rather than before execution.</p>
<p>Wikipedia</p>
</blockquote>
<p>Granted, it&rsquo;s not the kind of JIT compilation people usually talk about, and the performances will probably be terrible, but hey let&rsquo;s do it anyway.</p>
<p>Get your linker ready, here we go!</p>
<h2 id="building-a-dynamic-library-in-rust">Building a dynamic library in Rust</h2>
<p>Let&rsquo;s start simple, we&rsquo;ll create a dynamic library with a <code>hello</code> function in a single <code>hello.rs</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[no_mangle]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">hello</span>() {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;Hello, world!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here the <code>hello</code> function is marked as <em>extern</em>, this tell the compiler that we want to make this function available to other programs to use.</p>
<p>We will use <code>rustc</code> directly instead of cargo, this will make things easier later when compiling at runtime.
One of the arguments rustc accepts is the <em>crate type</em>, here we want a dynamic library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rustc --crate-type<span style="color:#f92672">=</span>dylib hello.rs
</span></span></code></pre></div><p>This will create a <code>libhello.so</code> on Linux (or a <code>.ddl</code> on Windows and <code>.dylib</code> on MacOs, but to be honest I don&rsquo;t really know how these OSes handle dynamic libraries so what I will say here applies mostly to Linux).</p>

<div class="notices note" ><p>Libraries traditionally begin with the <em>lib</em> prefix and some tools expect it, so if you decide to rename your output with the <code>-o</code> flag be sure to use the <em>lib</em> prefix too.</p>
</div>

<p>To check that it worked let&rsquo;s look for the hello symbol with <a href="https://linux.die.net/man/1/nm">nm</a>: <code>nm -D libhello.so | grep hello</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0000000000063160 T hello
</span></span></code></pre></div><p>Yes, the symbol is here, and according to the doc &lsquo;T&rsquo; means that it lives in the text (code) section (so it actually points to instructions, great) and the uppercase means that the symbol is global (exported).</p>
<p>I didn&rsquo;t comment about the <code>#[no_mangle]</code> bit, it tells the compiler net to do funny stuff with the function name, without it I got something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0000000000064160 T _ZN4dlib5hello17h40cf6e2e0e47355eE
</span></span></code></pre></div><p>Much harder to remember&hellip; And I doubt there are any kinds of stability guarantee.</p>
<h2 id="linking-our-library">Linking our library</h2>
<p>Now it&rsquo;s time to load our library, we will create a cargo project, let&rsquo;s say &lsquo;rs-jit&rsquo;, and declare an extern function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// src/main.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">extern</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">hello</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;Trying to load a library...&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsafe</span> { 
</span></span><span style="display:flex;"><span>        hello();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Running this will panic, indeed we need to do something to tell the compiler about our library.</p>
<p>When doing this kind of stuff it&rsquo;s often a good idea to also build the library as a part of the cargo build process, we can create a <code>build.rs</code> at the root to tell cargo how to build our dependencies:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// build.rs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">use</span> std::env;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::process::Command;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> out_dir <span style="color:#f92672">=</span> env::var(<span style="color:#e6db74">&#34;OUT_DIR&#34;</span>).unwrap();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Compile our dynamic library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Command::new(<span style="color:#e6db74">&#34;rustc&#34;</span>)
</span></span><span style="display:flex;"><span>        .args(<span style="color:#f92672">&amp;</span>[<span style="color:#e6db74">&#34;--crate-type=dylib&#34;</span>, <span style="color:#e6db74">&#34;dlib/hello.rs&#34;</span>, <span style="color:#e6db74">&#34;-o&#34;</span>])
</span></span><span style="display:flex;"><span>        .arg(<span style="color:#f92672">&amp;</span>format!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">/libhello.so&#34;</span>, out_dir))
</span></span><span style="display:flex;"><span>        .status()
</span></span><span style="display:flex;"><span>        .unwrap();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Linking directives
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    println!(<span style="color:#e6db74">&#34;cargo:rustc-link-search=</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, out_dir);
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;cargo:rustc-link-lib=dylib=hello&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Re-run this script only when the library has changed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    println!(<span style="color:#e6db74">&#34;cargo:rerun-if-changed=lib/hello.rs&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
<div class="notices note" ><p>You can learn more about build scripts <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html">here</a> and <a href="https://doc.rust-lang.org/cargo/reference/build-script-examples.html">here</a>.</p>
</div>

<p>This script assumes that we put our <code>hello.rs</code> file in a <code>dlib</code> folder, and will call rustc to build the library as we did before. What is great with this approach is that we can ask Cargo to re-build the library when the source file change.</p>
<p>Notice that we told cargo about our <em>hello</em> library and where to find it (in <code>out_dir</code>, which is somewhere in the <code>target/</code> directory).</p>
<p>Let&rsquo;s run it with <code>cargo run</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Trying to load a library...
</span></span><span style="display:flex;"><span>Hello, world!
</span></span></code></pre></div><p>Great, it worked!</p>
<p>It is also possible to inspect the dependencies of an executable with the <code>ldd</code> command, for instance with <code>ldd target/debug/rs-jit | grep hello</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rs" data-lang="rs"><span style="display:flex;"><span>	libhello.so <span style="color:#f92672">=&gt;</span> not found
</span></span></code></pre></div><p>Ho wait, not found? But it worked right?</p>
<p>Yes, that is because we told cargo where was our library, he is then running our executable with an updated environment that contains the library. In fact if we run our executable directly it will crash:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>./target/debug/rs-jit: error while loading shared libraries: libhello.so: cannot open shared object file: No such file or directory
</span></span></code></pre></div><p>We can ask cargo to tell us what he is doing exactly with the <code>-vv</code> (very verbose) flag.</p>
<p>When running <code>cargo run -vv</code> an inspecting the output there are quite a lot of flags, but one in particular caught my attention: <code>-L /home/&lt;path-to-my-folder&gt;/rs-jit/target/debug/build/rs-jit-923fa3340f768e20/out</code></p>
<p>Usually, the <code>-L</code> flags is used to tell a compiler where to look for libraries, so I strongly suspect it points to the dynamic library in the cargo <code>target</code> folder. We can check that by running the executable in an environment with the <code>LD_LIBRARY_PATH</code> set to this value, it&rsquo;s a variable used by the linker to look for libraries:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>LD_LIBRARY_PATH<span style="color:#f92672">=</span>/home/&lt;path-to-my-folder&gt;/debug/build/rs-jit-923fa3340f768e20/out ./target/debug/rs-jit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Trying to load a library...
</span></span><span style="display:flex;"><span>Hello, world!
</span></span></code></pre></div><p>And it works again!</p>
<h2 id="loading-libraries-at-runtime">Loading libraries at runtime</h2>
<p>Let&rsquo;s remove our <code>build.rs</code> and do the linking at runtime: translating the example of the <a href="https://linux.die.net/man/3/dlopen">manual</a> in rust is pretty straightforward if we don&rsquo;t mind doing things the C (unsafe) way.</p>
<p>Let&rsquo;s suppose we have a dynamic library <code>libhello.so</code> in the working directory, to call a function linked at runtime we need to:</p>
<ol>
<li>Load the library using <code>dlopen</code>.</li>
<li>Search for a symbol (the function) in the library with <code>dlsym</code>.</li>
<li>Close the library once we are done (with <code>dlclose</code>).</li>
</ol>
<p>The <code>libc</code> crate re-export all these functions, with their raw C interface, so it boils down to this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> libc::{c_void, dlclose, dlopen, dlsym, <span style="color:#66d9ef">RTLD_NOW</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::ffi::CString;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;Trying to load a library...&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsafe</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Load the library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> filename <span style="color:#f92672">=</span> CString::new(<span style="color:#e6db74">&#34;./libhello.so&#34;</span>).unwrap();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> handle <span style="color:#f92672">=</span> dlopen(filename.as_ptr(), <span style="color:#66d9ef">RTLD_NOW</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> handle.is_null() {
</span></span><span style="display:flex;"><span>            panic!(<span style="color:#e6db74">&#34;Failed to resolve dlopen&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Look for the function in the library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> fun_name <span style="color:#f92672">=</span> CString::new(<span style="color:#e6db74">&#34;hello&#34;</span>).unwrap();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> fun <span style="color:#f92672">=</span> dlsym(handle, fun_name.as_ptr());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> fun.is_null() {
</span></span><span style="display:flex;"><span>            panic!(<span style="color:#e6db74">&#34;Failed to resolve &#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;&#34;</span>, <span style="color:#f92672">&amp;</span>fun_name.to_str().unwrap());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// dlsym returns a C &#39;void*&#39;, cast it to a function pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> fun <span style="color:#f92672">=</span> std::mem::transmute::<span style="color:#f92672">&lt;*</span><span style="color:#66d9ef">mut</span> c_void, <span style="color:#66d9ef">fn</span>()<span style="color:#f92672">&gt;</span>(fun);
</span></span><span style="display:flex;"><span>        fun();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Cleanup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> ret <span style="color:#f92672">=</span> dlclose(handle);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ret <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            panic!(<span style="color:#e6db74">&#34;Error while closing lib&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s run it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Trying to load a library...
</span></span><span style="display:flex;"><span>Hello, world!
</span></span></code></pre></div><p>Perfect!</p>
<h2 id="a-kind-of-jit-compiler">A (kind of) JIT compiler</h2>
<p>Now we can:</p>
<ol>
<li>Build a dynamic library from rust (as we did in <code>build.rs</code>).</li>
<li>Load a dynamic library at runtime and call into a function.</li>
</ol>
<p>Let&rsquo;s combine both and create a JIT compiler!</p>
<p>I propose to build a simple calculator: the user can give an expression with two variables <code>a</code> and <code>b</code> and a value for those, then the expression is compiled by creating a small rust program and calling rustc on it, finally we link the library and call the function with the given values.</p>
<p>First we can build a small JIT engine backed by a file: when asked to compile an expression we write down a simple rust function by formatting a template</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::fs::File;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::io::prelude::<span style="color:#f92672">*</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::io::SeekFrom;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::process::Command;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">SOURCE_PATH</span>: <span style="color:#66d9ef">&amp;</span>&#39;static <span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp/jit.rs&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">LIB_PATH</span>: <span style="color:#66d9ef">&amp;</span>&#39;static <span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp/librsjit.so&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">FUN_NAME</span>: <span style="color:#66d9ef">&amp;</span>&#39;static <span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;calc&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">JitEngine</span> {
</span></span><span style="display:flex;"><span>    file: <span style="color:#a6e22e">File</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> JitEngine {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>() -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> file <span style="color:#f92672">=</span> File::create(<span style="color:#66d9ef">SOURCE_PATH</span>).expect(<span style="color:#e6db74">&#34;Could not create file&#34;</span>);
</span></span><span style="display:flex;"><span>        Self { file }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Compile and expression and return a wrapper around the linked function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">compile</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, expression: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; <span style="color:#a6e22e">Fun</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Reset the source file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        self.file.set_len(<span style="color:#ae81ff">0</span>).unwrap();
</span></span><span style="display:flex;"><span>        self.file.seek(SeekFrom::Start(<span style="color:#ae81ff">0</span>)).unwrap();
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Write the rust program
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        self.file
</span></span><span style="display:flex;"><span>            .write_all(
</span></span><span style="display:flex;"><span>                format!(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    #[no_mangle]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    pub extern fn calc(a: i64, b: i64) -&gt; i64 </span><span style="color:#ae81ff">{{</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                        </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                    </span><span style="color:#ae81ff">}}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                    expression
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                .as_bytes(),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            .unwrap();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Compile the sources
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Command::new(<span style="color:#e6db74">&#34;rustc&#34;</span>)
</span></span><span style="display:flex;"><span>            .args(<span style="color:#f92672">&amp;</span>[<span style="color:#e6db74">&#34;--crate-type=dylib&#34;</span>, <span style="color:#66d9ef">SOURCE_PATH</span>, <span style="color:#e6db74">&#34;-o&#34;</span>])
</span></span><span style="display:flex;"><span>            .arg(<span style="color:#66d9ef">LIB_PATH</span>)
</span></span><span style="display:flex;"><span>            .status()
</span></span><span style="display:flex;"><span>            .unwrap();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Return a wrapper around the function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">unsafe</span> { Fun::new(<span style="color:#66d9ef">LIB_PATH</span>, <span style="color:#66d9ef">FUN_NAME</span>) }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
<div class="notices warning" ><p>This is obviously a disaster from a security point of view, we are basically giving the user the right to execute arbitrary code on our machine, please don&rsquo;t do that in real life :)</p>
</div>

<p>The <code>Fun</code> struct in the previous snippet is a small wrapper around <code>dlopen</code>, it loads the library, then the symbol and close the library on <code>Drop</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#e6db74">/// A function from a library dynamically linked.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Fun</span> {
</span></span><span style="display:flex;"><span>    fun: <span style="color:#a6e22e">fn</span>(a: <span style="color:#66d9ef">i64</span>, b: <span style="color:#66d9ef">i64</span>) -&gt; <span style="color:#66d9ef">i64</span>,
</span></span><span style="display:flex;"><span>    handle: <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> c_void,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Fun {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>(lib_path: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>, fun_name: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>) -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Load the library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> filename <span style="color:#f92672">=</span> CString::new(lib_path).unwrap();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> handle <span style="color:#f92672">=</span> dlopen(filename.as_ptr(), <span style="color:#66d9ef">RTLD_NOW</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> handle.is_null() {
</span></span><span style="display:flex;"><span>            panic!(<span style="color:#e6db74">&#34;Failed to resolve dlopen&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Look for the function in the library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> fun_name <span style="color:#f92672">=</span> CString::new(fun_name).unwrap();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> fun <span style="color:#f92672">=</span> dlsym(handle, fun_name.as_ptr());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> fun.is_null() {
</span></span><span style="display:flex;"><span>            panic!(<span style="color:#e6db74">&#34;Failed to resolve &#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;&#34;</span>, <span style="color:#f92672">&amp;</span>fun_name.to_str().unwrap());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// dlsym returns a C &#39;void*&#39;, cast it to a function pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> fun <span style="color:#f92672">=</span> std::mem::transmute::<span style="color:#f92672">&lt;*</span><span style="color:#66d9ef">mut</span> c_void, <span style="color:#66d9ef">fn</span>(<span style="color:#66d9ef">i64</span>, <span style="color:#66d9ef">i64</span>) -&gt; <span style="color:#66d9ef">i64</span><span style="color:#f92672">&gt;</span>(fun);
</span></span><span style="display:flex;"><span>        Self { fun, handle }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">call</span>(<span style="color:#f92672">&amp;</span>self, a: <span style="color:#66d9ef">i64</span>, b: <span style="color:#66d9ef">i64</span>) -&gt; <span style="color:#66d9ef">i64</span> {
</span></span><span style="display:flex;"><span>        (self.fun)(a, b)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Drop <span style="color:#66d9ef">for</span> Fun {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">drop</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">unsafe</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> ret <span style="color:#f92672">=</span> dlclose(self.handle);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ret <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>                panic!(<span style="color:#e6db74">&#34;Error while closing lib&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And then we are good to go! Let&rsquo;s write a small program jitting some expressions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> jit <span style="color:#f92672">=</span> JitEngine::new();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">loop</span> {
</span></span><span style="display:flex;"><span>        println!(<span style="color:#e6db74">&#34;Value for a:&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> a <span style="color:#f92672">=</span> read_value();
</span></span><span style="display:flex;"><span>        println!(<span style="color:#e6db74">&#34;Value for b:&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> b <span style="color:#f92672">=</span> read_value();
</span></span><span style="display:flex;"><span>        println!(<span style="color:#e6db74">&#34;Expression:&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> expression <span style="color:#f92672">=</span> read_expression();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> fun <span style="color:#f92672">=</span> jit.compile(<span style="color:#f92672">&amp;</span>expression);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> fun.call(a, b);
</span></span><span style="display:flex;"><span>        println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, result);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You can find the full source code <a href="https://gist.github.com/CharlyCst/1ba59e09f7ff9f844a5e907746d0c52e">here</a>.</p>
<p>Let&rsquo;s compile and try it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Value for a:
</span></span><span style="display:flex;"><span>3
</span></span><span style="display:flex;"><span>Value for b:
</span></span><span style="display:flex;"><span>4
</span></span><span style="display:flex;"><span>Expression:
</span></span><span style="display:flex;"><span>a*b
</span></span><span style="display:flex;"><span>12
</span></span></code></pre></div><p>Yeah, it works! There is ~1s of latency for computing the result, due to the call to rustc, but we are not here for performances anyway ¯\_(ツ)_/¯</p>
<p>Hope you enjoyed this post, feel free to report any bug/error or post a comment on <a href="https://github.com/CharlyCst/CharlyCst.github.io/issues">github</a> or on the <a href="https://gist.github.com/CharlyCst/1ba59e09f7ff9f844a5e907746d0c52e">source code</a>.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://charlycst.github.io/tags/rust">rust</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>1708 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-03-27</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://charlycst.github.io/posts/tla-cli/">
                                <span class="button__icon">←</span>
                                <span class="button__text">Using the TLA⁺ Command Line Interface</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://charlycst.github.io/posts/wasm-memory-allocator/">
                                <span class="button__text">Building a Memory Allocator for WebAssembly</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2023</span>
            
                <span><a href="https://charlycst.github.io">Charly Castes</a></span>
            
            
            <span><a href="https://charlycst.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.6697ced562b071c5399a9f9042aee0db06b2346c0a3090facbcbc39ef4ff67a255fa797a9e66c112466324f5ea76dd023656e23d15cc61555260562e29ea5ed2.js" integrity="sha512-ZpfO1WKwccU5mp&#43;QQq7g2wayNGwKMJD6y8vDnvT/Z6JV&#43;nl6nmbBEkZjJPXqdt0CNlbiPRXMYVVSYFYuKepe0g=="></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-156991616-1', 'auto');
        ga('send', 'pageview');
    </script>



    </body>
</html>
